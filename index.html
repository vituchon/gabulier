<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="./toastr.css">
  <script type="text/javascript" src="./toastr.js"></script>

  <title>Gabulier</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #game-area {
      width: 80vw;
      height: 30vh;
      background-color: lightblue;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px solid #0077cc;
      border-radius: 10px;
      position: relative;
    }
    #target {
      position: absolute;
      font-size: 2em;
    }
    .ice-cube {
      position: absolute;
      font-size: 1.5em;
      animation: fall 2s ease-out forwards;
    }
    #moving-image {
      position: absolute;
      left: -100px;
      transform: translateX(0);
      transition: transform 0.5s ease-in-out;
      height: 100px;
      width: auto;
      object-fit: contain;
    }
    #counter {
      margin: auto;
      font-size: 4em;
      color: red;
    }
    #insidious {
      transition: all 2s ease-in-out;
      color: red;
    }
    #insidious.reveal {
      opacity: 1;
    }
    #insidious.hide {
      opacity: 0;
    }

  </style>
</head>
<body>
  <div id="score" style="font-size: 2em; color: rebeccapurple;">0 Gabush</div>
  <span>No le pongas hielo al vino!!üò§</span>
  <span>Aparta los hielos de la copa haciendo click sobre ellos</span>
  <span>El buen gusto y la punter√≠a importan!</span>
  <span id="insidious" class="hide">El hielero se puso <b>incidioso</b></span>
  <div id="game-area" class="centered-div">
    <div id="target" class="target">üç∑</div>
    <div id="counter"></div>
  </div>
  <img id="moving-image" height="80px" src="./gabuneutral.png" />

  <script>
      const iceCube = document.createElement('div');
      iceCube.className = 'ice-cube';
      iceCube.textContent = 'üßä';
      document.body.appendChild(iceCube);
      const iceCubeRect = iceCube.getBoundingClientRect();
      document.body.removeChild(iceCube);

      function displayMessage(message) {
        Toastify({
          text: message,
          duration: 3000,
          newWindow: true,
          gravity: "top",
          position: 'left',
          style: {
            "font-size": "1.5em",
            "border-radius": "0.5em",
          }
        }).showToast();
      }

  </script>
  <script>
    const gameArea = document.getElementById('game-area');
    const target = document.getElementById('target');

    const targetX = gameArea.clientWidth * (0.3 + Math.random() * 0.3);
    const targetY = gameArea.clientHeight - iceCubeRect.height - 10
    target.style.left = `${targetX}px`;
    target.style.top = `${targetY}px`;

    let score = 0;
    const scoreDisplay = document.getElementById('score');
    const durationByScore = {
      0: 4000,
      10: 3500,
      30: 3000,
      50: 2500,
      80: 2000,
      100: 1500,
      150: 1000,
    }
    let lastDuration = 4000
    function throwIceCube() {
      const iceCube = document.createElement('div');
      iceCube.className = 'ice-cube';
      iceCube.textContent = 'üßä';

      const startX = Math.random() > 0.5 ? - parseFloat(iceCubeRect.width) : window.innerWidth;
      const startY = targetY - window.innerHeight * ( 0.4 * Math.random());
      iceCube.style.left = `${startX}px`;
      iceCube.style.top = `${startY}px`;

      gameArea.appendChild(iceCube);

      const duration = durationByScore[score]|| lastDuration;
      lastDuration = duration;
      const startTime = performance.now();
      var g = 500 + (Math.random() * 500)
      var trusth = 0.03

      function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const t = Math.min(elapsed / duration, 1);

        const x = (1 - t) * startX + t * targetX;
        const y = startY + t * (t - 1) * g + t * (targetY - startY);
        iceCube.style.left = `${x}px`;
        iceCube.style.top = `${y}px`;

        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          const hasBeenRemovedFromDOM = !iceCube.parentNode
          if (!hasBeenRemovedFromDOM) {
            gameArea.removeChild(iceCube);
            onIceCubeLand()
          }
        }
        g += trusth
        trusth *= 1.023
      }
      requestAnimationFrame(animate);

      iceCube.addEventListener('click', onIceCubeClick);
      const incidious = document.getElementById("insidious")
      function onIceCubeClick() {
        iceCube.removeEventListener('click', onIceCubeClick);
        iceCube.style.transition = 'opacity 0.5s ease-out';
        iceCube.style.opacity = '0';

        score += 10;
        scoreDisplay.textContent = `${score} Gabush`;
        if (score >= 10 && !incidious.dataset.flag) {
          incidious.dataset.flag = true
          incidious.classList.remove("hide");
          incidious.classList.add("reveal");
          setTimeout(() => {
            incidious.classList.remove("reveal");
            incidious.classList.add("hide");
          }, 2000);
        }

        setTimeout(() => {
          gameArea.removeChild(iceCube);
        }, 500);
        updateInterval()
      }
    }

    const steps = 10
    let currentStep = 0;

    const movingImage = document.getElementById('moving-image');
    const movingImageRect = movingImage.getBoundingClientRect();
    const gameAreaRect = gameArea.getBoundingClientRect();
    const totalDistance = gameAreaRect.width - movingImageRect.width;
    const stepDistance = totalDistance / steps;
    var hasLost = false
    function onIceCubeLand() {
      if (hasLost) {
        return
      }
      if (currentStep < steps) {
        currentStep++
        moveImage(currentStep)
        hasLost = currentStep == steps
      }
      if (hasLost) {
        clearInterval(interval)
        displayMessage("!Has perdido! üò±")
      }
    }

    let secondsToStart = 1
    document.getElementById('counter').innerText = secondsToStart
    let gameStartInterval = setInterval(() => {
      secondsToStart--
      if (secondsToStart == 0) {
        clearInterval(gameStartInterval)
        startGame()
        setTimeout(() => {
          document.getElementById('counter').innerText = ""
        }, 500)
      }
      document.getElementById('counter').innerText = secondsToStart
    }, 1000)

    const originalSrc = movingImage.src;
    const movingSrc = "./gabushock.png"
    movingImage.addEventListener("transitionend", () => {
      movingImage.src = originalSrc;
    });
    function moveImage(step) {
      const newPosition = stepDistance * step;
      movingImage.src = movingSrc;
      movingImage.style.transform = `translateX(${newPosition}px)`;
    }

    function initImage() {
      movingImage.style.left =`${gameAreaRect.x}px`;
      movingImage.style.top =`${gameAreaRect.y + gameAreaRect.height}px`;
    }


    function startGame() {
      displayMessage("A jugar!")
      currentStep = 0
      score = 0
      scoreDisplay.textContent = `${score} Gabush`;
      throwIceCube()
      interval = setInterval(throwIceCube, 4000);
      initImage();
    }

    const spawnDeltaByScore = {
      0: 4000,
      10: 3000,
      20: 2000,
      30: 1000,
      40: 500,
    }
    let lastDelta = 4000
    function updateInterval() {
      if (hasLost) {
        return
      }
      const delta = spawnDeltaByScore[score] || lastDelta;
      lastDelta = delta
      clearInterval(interval);
      interval = setInterval(() => {
        throwIceCube();
      }, delta);
    }
  </script>
</body>
</html>
